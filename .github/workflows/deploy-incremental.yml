name: üöÄ Deploy DigiUrban React App

# Controle de concorr√™ncia - √öNICO deploy por vez
concurrency:
  group: digiurban-production-deploy
  cancel-in-progress: true

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'package*.json'
      - 'sql-scripts/**'
      - '.github/workflows/**'
  workflow_dispatch:

env:
  VPS_HOST: '31.97.85.98'
  VPS_USER: 'root'
  APP_DIR: '/root/digiurban'
  APP_PORT: '3002'

jobs:
  analyze-changes:
    name: üîç Analisar Mudan√ßas
    runs-on: ubuntu-latest
    outputs:
      has_code_changes: ${{ steps.changes.outputs.has_code_changes }}
      has_package_changes: ${{ steps.changes.outputs.has_package_changes }}
      has_config_changes: ${{ steps.changes.outputs.has_config_changes }}
      needs_restart: ${{ steps.changes.outputs.needs_restart }}
      deploy_type: ${{ steps.changes.outputs.deploy_type }}
    
    steps:
    - name: üì• Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 2
    
    - name: üîç Analisar arquivos alterados
      id: changes
      run: |
        echo "üîç Analisando mudan√ßas desde o √∫ltimo commit..."
        
        # Obter arquivos alterados
        CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "all")
        echo "üìÅ Arquivos alterados:"
        echo "$CHANGED_FILES"
        
        # Inicializar flags
        HAS_CODE=false
        HAS_PACKAGE=false
        HAS_CONFIG=false
        NEEDS_RESTART=false
        
        # Analisar tipos de mudan√ßas para DigiUrban React App
        if echo "$CHANGED_FILES" | grep -E "(src/.*\.(js|ts|tsx|jsx|json)|vite\.config\.(js|ts)|index\.html)" > /dev/null; then
          HAS_CODE=true
          echo "‚úÖ Mudan√ßas de c√≥digo frontend detectadas"
        fi
        
        if echo "$CHANGED_FILES" | grep -E "package(-lock)?\.json" > /dev/null; then
          HAS_PACKAGE=true
          echo "üì¶ Mudan√ßas em depend√™ncias detectadas"
        fi
        
        if echo "$CHANGED_FILES" | grep -E "(\.env|vite\.config\.(js|ts)|tailwind\.config\.(js|ts))" > /dev/null; then
          HAS_CONFIG=true
          echo "‚öôÔ∏è Mudan√ßas de configura√ß√£o detectadas"
        fi
        
        # Determinar se precisa restart
        if [[ "$HAS_CODE" == "true" || "$HAS_CONFIG" == "true" ]]; then
          NEEDS_RESTART=true
        fi
        
        # Determinar tipo de deploy
        if [[ "$HAS_PACKAGE" == "true" ]]; then
          DEPLOY_TYPE="full"
          echo "üîÑ Deploy completo necess√°rio (depend√™ncias mudaram)"
        elif [[ "$HAS_CODE" == "true" ]]; then
          DEPLOY_TYPE="code-only"
          echo "üìù Deploy apenas de c√≥digo"
        elif [[ "$HAS_CONFIG" == "true" ]]; then
          DEPLOY_TYPE="config-only"
          echo "‚öôÔ∏è Deploy apenas de configura√ß√£o"
        else
          DEPLOY_TYPE="minimal"
          echo "üìã Deploy m√≠nimo (docs/workflows)"
        fi
        
        # Definir outputs
        echo "has_code_changes=$HAS_CODE" >> $GITHUB_OUTPUT
        echo "has_package_changes=$HAS_PACKAGE" >> $GITHUB_OUTPUT
        echo "has_config_changes=$HAS_CONFIG" >> $GITHUB_OUTPUT
        echo "needs_restart=$NEEDS_RESTART" >> $GITHUB_OUTPUT
        echo "deploy_type=$DEPLOY_TYPE" >> $GITHUB_OUTPUT

  deploy:
    name: üöÄ Deploy Incremental
    runs-on: ubuntu-latest
    needs: analyze-changes
    timeout-minutes: 15
    
    steps:
    - name: üìã Info do Deploy Incremental
      run: |
        echo "üöÄ Deploy Incremental DigiUrban"
        echo "=============================================="
        echo "Commit: ${{ github.sha }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "Tipo de Deploy: ${{ needs.analyze-changes.outputs.deploy_type }}"
        echo "Mudan√ßas de C√≥digo: ${{ needs.analyze-changes.outputs.has_code_changes }}"
        echo "Mudan√ßas de Depend√™ncias: ${{ needs.analyze-changes.outputs.has_package_changes }}"
        echo "Precisa Restart: ${{ needs.analyze-changes.outputs.needs_restart }}"
        echo "=============================================="

    - name: üîë Configurar SSH
      run: |
        echo "üîë Configurando SSH para deploy incremental..."
        sudo apt-get update && sudo apt-get install -y sshpass
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ env.VPS_HOST }} >> ~/.ssh/known_hosts
        echo "‚úÖ SSH configurado"

    - name: üîç Verificar estado atual da VPS
      run: |
        echo "üîç Verificando estado atual..."
        sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          echo '=== Estado Atual da VPS ==='
          echo 'Docker version:'
          docker --version || echo 'Docker n√£o encontrado'
          
          echo ''
          echo 'Docker Compose version:'
          if command -v 'docker compose' >/dev/null 2>&1; then
            docker compose version
            DOCKER_COMPOSE_CMD='docker compose'
          elif command -v 'docker-compose' >/dev/null 2>&1; then
            docker-compose version
            DOCKER_COMPOSE_CMD='docker-compose'
          else
            echo 'Docker Compose n√£o encontrado'
            DOCKER_COMPOSE_CMD='none'
          fi
          
          echo ''
          echo 'Docker Containers:'
          docker ps --format 'table {{.Names}}\t{{.Status}}' | grep nginx-digiurban || echo 'Nginx n√£o rodando'
          
          echo ''
          echo 'Aplica√ß√£o React status:'
          if docker ps | grep -q nginx-digiurban; then
            echo '‚úÖ Nginx DigiUrban rodando'
            docker ps | grep nginx-digiurban
          else
            echo '‚ùå Nginx DigiUrban n√£o encontrado'
          fi
          
          echo ''
          echo '√öltima atualiza√ß√£o:'
          cd ${{ env.APP_DIR }} && git log --oneline -1 2>/dev/null || echo 'Reposit√≥rio n√£o inicializado'
        "

    - name: üì¶ Backup Inteligente (somente se necess√°rio)
      if: needs.analyze-changes.outputs.deploy_type == 'full'
      run: |
        echo "üì¶ Fazendo backup completo (deploy full)..."
        sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          TIMESTAMP=\$(date +%Y%m%d_%H%M%S)
          BACKUP_DIR=/opt/digiurban-backups/backup_\$TIMESTAMP
          mkdir -p \$BACKUP_DIR
          
          # Backup da build anterior se existir
          if [ -d ${{ env.APP_DIR }}/dist ]; then
            cp -r ${{ env.APP_DIR }}/dist \$BACKUP_DIR/dist_backup
            echo '‚úÖ Build anterior backed up'
          fi
          
          # Backup da configura√ß√£o atual
          if [ -f ${{ env.APP_DIR }}/.env ]; then
            cp ${{ env.APP_DIR }}/.env \$BACKUP_DIR/
            echo '‚úÖ Environment file backed up'
          fi
          
          echo \"üì¶ Backup completo criado: \$BACKUP_DIR\"
        "

    - name: üì¶ Backup R√°pido (somente dados cr√≠ticos)
      if: needs.analyze-changes.outputs.deploy_type != 'full'
      run: |
        echo "üì¶ Backup r√°pido (apenas dados cr√≠ticos)..."
        sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          if [ -f ${{ env.APP_DIR }}/.env ]; then
            cp ${{ env.APP_DIR }}/.env /tmp/env_backup
            echo '‚úÖ Environment preservado'
          fi
          
          # Backup da build anterior se existir
          if [ -d ${{ env.APP_DIR }}/dist ]; then
            tar -czf /tmp/dist_backup.tar.gz -C ${{ env.APP_DIR }} dist
            echo '‚úÖ Build anterior preservado'
          fi
        "

    - name: üê≥ Instalar Docker e Docker Compose
      run: |
        echo "üê≥ Garantindo Docker e Docker Compose..."
        sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          # Criar diret√≥rio se n√£o existir
          mkdir -p ${{ env.APP_DIR }}
          cd ${{ env.APP_DIR }}
          
          # Instalar Docker se n√£o estiver instalado
          if ! command -v docker >/dev/null 2>&1; then
            echo 'üì¶ Instalando Docker...'
            curl -fsSL https://get.docker.com -o get-docker.sh
            sh get-docker.sh
            systemctl enable docker
            systemctl start docker
            echo '‚úÖ Docker instalado'
          else
            echo '‚úÖ Docker j√° instalado'
            docker --version
          fi
          
          # Instalar Docker Compose standalone se n√£o estiver dispon√≠vel
          if ! command -v 'docker compose' >/dev/null 2>&1 && ! command -v 'docker-compose' >/dev/null 2>&1; then
            echo 'üì¶ Instalando Docker Compose standalone...'
            COMPOSE_VERSION=\$(curl -s https://api.github.com/repos/docker/compose/releases/latest | grep 'tag_name' | cut -d'\"' -f4)
            curl -L \"https://github.com/docker/compose/releases/download/\${COMPOSE_VERSION}/docker-compose-\$(uname -s)-\$(uname -m)\" -o /usr/local/bin/docker-compose
            chmod +x /usr/local/bin/docker-compose
            echo '‚úÖ Docker Compose standalone instalado'
            docker-compose --version
          else
            echo '‚úÖ Docker Compose j√° dispon√≠vel'
            if command -v 'docker compose' >/dev/null 2>&1; then
              docker compose version
            else
              docker-compose --version
            fi
          fi
        "

    - name: üöÄ Deploy usando Script de Produ√ß√£o
      run: |
        echo "üöÄ Executando deploy com script de produ√ß√£o..."
        sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          # Garantir que o diret√≥rio existe
          mkdir -p ${{ env.APP_DIR }}
          cd ${{ env.APP_DIR }}
          
          # Clonar ou atualizar o reposit√≥rio primeiro
          if [ ! -d .git ]; then
            echo 'üÜï Clonando reposit√≥rio...'
            git clone https://github.com/${{ github.repository }}.git .
          else
            echo 'üì• Atualizando reposit√≥rio...'
            git fetch origin
            git reset --hard origin/main
          fi
          
          # Deploy DigiUrban React App
          echo 'üöÄ Executando deploy DigiUrban React App...'
          
          # Instalar depend√™ncias
          echo 'üì¶ Installing dependencies...'
          if command -v npm >/dev/null 2>&1; then
            npm ci
          else
            echo '‚ùå Node.js/npm n√£o encontrado! Instalando...'
            curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
            apt-get install -y nodejs
            npm ci
          fi
          
          # Build do frontend
          echo 'üèóÔ∏è Building React app...'
          npm run build
          
          # Verificar se o build existe e tem conte√∫do
          if [ ! -f "dist/index.html" ]; then
            echo '‚ùå Build falhou! Tentando novamente...'
            npm run build
            if [ ! -f "dist/index.html" ]; then
              echo '‚ùå Build falhou definitivamente!'
              exit 1
            fi
          fi
          
          echo 'üìÅ Conte√∫do do build:'
          ls -la dist/
          
          # Parar container anterior se existir
          echo 'üîÑ Parando container anterior...'
          docker rm -f nginx-digiurban 2>/dev/null || true
          
          # Iniciar nginx com React app na porta 3002
          echo 'üöÄ Deploying React app to nginx on port ${{ env.APP_PORT }}...'
          docker run -d --name nginx-digiurban \
            -p ${{ env.APP_PORT }}:80 \
            -v "$(pwd)/dist:/usr/share/nginx/html:ro" \
            --restart unless-stopped \
            nginx:alpine
          
          # Aguardar nginx inicializar
          echo '‚è≥ Aguardando nginx inicializar...'
          sleep 10
          
          # Verificar se est√° funcionando
          echo 'üîç Testando React app...'
          for i in {1..5}; do
            if curl -f -s http://localhost:${{ env.APP_PORT }}/ >/dev/null 2>&1; then
              echo '‚úÖ React app funcionando!'
              break
            else
              echo "‚è≥ Tentativa $i/5..."
              sleep 5
            fi
            
            if [ $i -eq 5 ]; then
              echo '‚ùå React app n√£o respondeu ap√≥s 5 tentativas'
              docker logs nginx-digiurban
              exit 1
            fi
          done
          
          echo '‚úÖ DigiUrban React App deployed successfully on port ${{ env.APP_PORT }}'
          
          echo '‚úÖ Deploy da aplica√ß√£o React conclu√≠do'
        "


    - name: üîç Verifica√ß√£o R√°pida
      run: |
        echo "üîç Verifica√ß√£o final..."
        sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          cd ${{ env.APP_DIR }}
          
          # Verificar status do container nginx
          echo 'üîç Status do container nginx:'
          if docker ps | grep -q nginx-digiurban; then
            echo '‚úÖ Nginx DigiUrban rodando'
            docker ps | grep nginx-digiurban
          else
            echo '‚ùå Nginx DigiUrban n√£o encontrado'
            echo 'üîç Verificando todos os containers:'
            docker ps -a | grep nginx-digiurban || echo 'Container n√£o existe'
            exit 1
          fi
          
          # Verificar health check da aplica√ß√£o React
          echo 'üîç Testando aplica√ß√£o React...'
          for i in {1..3}; do
            if curl -f -s http://localhost:${{ env.APP_PORT }}/ >/dev/null 2>&1; then
              echo '‚úÖ Aplica√ß√£o React respondendo'
              break
            else
              echo \"‚è≥ Tentativa \$i/3...\"
              sleep 5
            fi
            
            if [ \$i -eq 3 ]; then
              echo '‚ùå Aplica√ß√£o React n√£o est√° respondendo'
              docker logs nginx-digiurban --tail 10
              exit 1
            fi
          done
        "

    - name: üìä Relat√≥rio do Deploy Incremental
      if: always()
      run: |
        echo "üìä RELAT√ìRIO DO DEPLOY INCREMENTAL"
        echo "=================================="
        sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          echo 'Tipo de Deploy: ${{ needs.analyze-changes.outputs.deploy_type }}'
          echo 'Restart Executado: ${{ needs.analyze-changes.outputs.needs_restart }}'
          echo 'Depend√™ncias Atualizadas: ${{ needs.analyze-changes.outputs.has_package_changes }}'
          echo ''
          
          echo '=== Status da Aplica√ß√£o React ==='
          cd ${{ env.APP_DIR }}
          
          # Verificar container nginx
          if docker ps | grep -q nginx-digiurban; then
            echo '‚úÖ Nginx DigiUrban rodando'
            docker ps | grep nginx-digiurban
          else
            echo '‚ùå Nginx DigiUrban n√£o encontrado'
          fi
          
          echo ''
          echo '=== √öltimo Commit ==='
          git log --oneline -1
          
          echo ''
          echo 'üéØ Aplica√ß√£o React: http://${{ env.VPS_HOST }}:${{ env.APP_PORT }}'
          echo '‚ö° Deploy incremental DigiUrban React conclu√≠do!'
        "

    - name: üéâ Deploy Incremental Conclu√≠do
      run: |
        echo "üéâ DEPLOY INCREMENTAL DIGIURBAN REACT REALIZADO COM SUCESSO!"
        echo "‚ö° Tipo: ${{ needs.analyze-changes.outputs.deploy_type }}"
        echo "üõ°Ô∏è Deploy preservou configura√ß√µes existentes"
        echo "üöÄ Aplica√ß√£o React: http://${{ env.VPS_HOST }}:${{ env.APP_PORT }}"